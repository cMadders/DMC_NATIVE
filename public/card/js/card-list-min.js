$(document).ready(function(){function a(){f(),b(),window.DMC.Native.data.creative_count>21?(k(),$("#dmc-card-container").addClass("filter")):m("all"),$("#card-list-filter li").removeClass("active"),$('#card-list-filter li[data-category="all"]').addClass("active"),t(window.DMC.Native.data.extra.dmc_index_url,window.DMC.Native.data.extra.dmc_index_url_short),c(),window.addEventListener("message",function(a){if(a.data.type&&"dmc-card-message"===a.data.type)switch(a.data.key){case"page_url":z=a.data.value,d(z)}},!1),window.addEventListener("resize",c),window.parent.postMessage("dmc-card-initialized","*"),TweenLite.to($("#dmc-card-container"),.5,{opacity:"1",ease:Power1.easeOut})}function b(){var a,b=window.addEventListener?"addEventListener":"attachEvent",c=window[b],d="attachEvent"==b?"onmessage":"message";c(d,function(b){if("dmc-clixie-player-ready"===b.data.id){var c=u;c.id="dmc-init-clixie-player";var d=document.getElementById("clixie-video-player").contentWindow;d.postMessage(c,"*")}if("dmc-clixie-toast-clicked"===b.data.id){try{var f="clixie";if(a=q(),u&&g(f.toLowerCase(),u.extra.listingID),w){var h="Apply";a.medium=f,mixpanel.track(h,a)}}catch(i){console.error(i)}u&&u.link.website&&window.open(u.link.website)}if("dmc-clixie-video-play"===b.data.id)try{a=q(),e(a),g("video_play",a.listingID)}catch(i){console.error(i)}},!1)}function c(){window.parent.postMessage("dmc-get-card-dimensions","*");var a=window.innerHeight-109;$("#card-list").css("height",a),$("#card-detail").css("height",a)}function d(a){console.log("initMixPanel",a),w=!0,mixpanel.track("IVB Engaged",{url:a,id:window.DMC.Native.data._id,short_id:window.DMC.Native.data.short_id,publisher:window.DMC.Native.data.publisher,site:window.DMC.Native.data.site,name:window.DMC.Native.data.name})}function e(a){v&&v.addEvent("video_plays",a,function(a,b){a&&console.error("error logging beacon",a)}),w&&(a.url=z,a.id=window.DMC.Native.data._id,a.short_id=window.DMC.Native.data.short_id,a.publisher=window.DMC.Native.data.publisher,a.site=window.DMC.Native.data.site,a.name=window.DMC.Native.data.name,mixpanel.track("Video Play",a))}function f(){$.get("//widgets.digitalmediacommunications.com/analytics/get_token",function(a){var b=JSON.parse(a);x=b.hash})}function g(a,b,c){var d="http://widgets.digitalmediacommunications.com/analytics/clicks",e="native";"apply"==a&&(a="apply_here");var f=[b.toString(),a,"M1",e,window.DMC.Native.data.extra.dmc_publication_id,z];console.log("fireXUL_Beacon",f),x&&$.ajax({type:"POST",url:d,data:{ci_csrf_token:x,data:JSON.stringify(f)},success:function(a){}})}function h(){$("#dmc-card-container").addClass("filter-menu-open")}function i(){c()}function j(){$("#card-header").css("position","fixed"),$("#dmc-card-container").removeClass("filter-menu-open"),c()}function k(){$("#card-header").css("position","absolute"),$("#card-list-filter").scrollTop(0);var a=window.innerWidth-70;TweenLite.to($("#card"),.3,{left:a+"px",onStart:h,onComplete:i,ease:Power1.easeOut})}function l(a){a=a||0,$("#dmc-card-container").removeClass("filter"),TweenLite.to($("#card"),.3,{left:"0",onComplete:j,ease:Power1.easeOut})}function m(a){$("#card-list .item").hide(),"all"!==a?($('.item[data-category="'+a+'"]').show(),$("#card").scrollTop(0),$("#card-list").scrollTop(0)):$(".item").show(),l(".3")}function n(){window.scrollTo(0,0),c(),$("html, body").addClass("disable-scroll");var a=window.innerWidth/1.77778;$("#clixie-video-player").attr("height",Math.round(a))}function o(){$("#card-detail").scrollTop(0),$("html, body").removeClass("disable-scroll"),$("#card-detail").css("display","none"),c(),$("html body").animate({scrollTop:y},300)}function p(){document.getElementById("native-video-player")&&(document.getElementById("native-video-player").currentTime=0,document.getElementById("native-video-player").pause()),document.getElementById("clixie-video-player")&&$("#clixie-video-player").attr("src",""),$("#card-detail .coupon").hide(),$("#card-detail .address").hide(),$("#card-detail .map").hide(),u=null}function q(){var a={};if(a.url=z,a.id=window.DMC.Native.data._id,a.short_id=window.DMC.Native.data.short_id,a.publisher=window.DMC.Native.data.publisher,a.site=window.DMC.Native.data.site,a.name=window.DMC.Native.data.name,u){var b=u.extra.clixie_vid_uuid&&"0"!==u.extra.clixie_vid_uuid?"Clixie":"DMC";a={id:u._id,listingID:u.extra.listingID,dmcAdNumber:u.extra.dmcAdNumber,headline:u.headline,tagline:u.tagline,category:u.category,vertical:u.vertical,website:u.link.website,referrer:document.referrer,type:"listing",videoType:b,keen:{timestamp:(new Date).toISOString()}}}else a={type:"ivb",referrer:document.referrer,keen:{timestamp:(new Date).toISOString()}};return a}function r(){var a=$("#entry-template").html(),b=Handlebars.compile(a);u.extra.clixie_vid_uuid&&"0"!=u.extra.clixie_vid_uuid&&(u.isClixie=!0);var c=b(u);$("#entryOutput").html(c)}function s(){var a=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(a)?"windows":/android/i.test(a)?"android":/iPad|iPhone|iPod/.test(a)&&!window.MSStream?"iOS":"unknown"}function t(a,b,c,d){if(c?(u.vertical&&"employment"!=u.vertical.toLowerCase()&&$("#card-footer .apply p").text("Visit Website"),$("#card-footer .apply").show(),$("#card-footer .apply").attr("href",c),$("#card-footer").removeClass("reverse")):($("#card-footer .apply").hide(),$("#card-footer").addClass("reverse")),a){$("#card-footer .share").show();var e=encodeURIComponent(window.DMC.Native.data.publisher+": "+window.DMC.Native.data.headline+", "+a);b||(b=a),d&&(e="retail"==u.vertical.toLowerCase()||"real estate"==u.vertical.toLowerCase()?encodeURIComponent("Check out this video from "+d.advertiser+", "+b):encodeURIComponent(d.advertiser+" has an opening for "+d.tagline+"! Check out this video, "+b));var f="https://www.facebook.com/dialog/feed?app_id=484257678295938&display=popup&redirect_uri=";f=f+encodeURIComponent(a)+"&link="+encodeURIComponent(a)+"&caption="+encodeURIComponent(window.DMC.Native.data.publisher+": "+window.DMC.Native.data.headline),$("#card-footer .fb").attr("href",f),!d&&b&&(e=encodeURIComponent(window.DMC.Native.data.publisher+": "+window.DMC.Native.data.headline+", "+b));var g="https://twitter.com/intent/tweet?text=";g+=e,$("#card-footer .twitter").attr("href",g);var h="sms:&body="+e;"iOS"!=s()&&(h="sms:?body="+e),$("#card-footer .sms").attr("href",h)}else $("#card-footer .share").hide(),$("#card-footer").addClass("reverse")}var u,v,w,x,y=0,z="http://www.digitalmediacommunications.com";$("#card-header .filter.category").click(function(a){a.preventDefault(),$("#dmc-card-container").toggleClass("filter"),$("#dmc-card-container").hasClass("filter")?k():l(".3")}),$("#card-header .close-card").click(function(a){a.preventDefault(),window.parent.postMessage("dmc-eject-card","*")}),$("#card-list-filter li").click(function(a){a.preventDefault(),$("#card-list-filter li").removeClass("active"),$(this).addClass("active"),m($(this).data("category"))}),$("#card-header .back").click(function(a){a.preventDefault(),p(),$("#card-header .filter").show(),$("#card-header .back").hide(),$("#card-footer .apply").hide(),$("#card-footer").addClass("reverse"),t(window.DMC.Native.data.extra.dmc_index_url,window.DMC.Native.data.extra.dmc_index_url_short);var b=window.innerWidth,c=0;TweenLite.to($("#card-detail"),.5,{left:b,delay:c,onComplete:o,ease:Power1.easeOut})}),$("#card-footer a").click(function(a){var b=$(this).data("medium"),c="share_actions";"Apply"===b&&(c="apply_actions"),u&&g(b.toLowerCase(),u.extra.listingID),v&&u&&v.trackExternalLink(a,c,{creative:u,medium:b});var d=q();w&&(c="share_actions"==c?"Share":"Apply",d.medium=b,mixpanel.track(c,d))}),$("#card-list .item").click(function(a){if(a.preventDefault(),$("#dmc-card-container").hasClass("filter-menu-open"))return l();var b=$(this).data("id");$.each(DMC.Native.data.creatives_compiled,function(a,c){return c._id===b?(u=c,!1):void 0}),y=document.body.scrollTop,r(),t(u.link.slp,u.link.slp_short,u.link.website,{advertiser:u.advertiser,tagline:u.tagline});var c=0;TweenLite.to($("#card-detail"),.5,{left:"0",display:"block",delay:c,onComplete:n,ease:Power1.easeOut}),$("#card-header .filter").hide(),$("#card-header .back").css("display","flex");var d=q();e(d);var f="Clixie"==d.videoType;g("video_play",d.listingID,f)}),a()});